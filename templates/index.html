<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Maestro Certificate Rotation Dashboard</title>
  <link rel="stylesheet" href="/static/css/app.css" />
  <!-- Critical CSS fallback to keep UI usable if app.css fails -->
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--soft:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:10}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:14px 20px}
    .uploader{display:flex;gap:12px;align-items:center}
    .drop-zone{border:2px dashed var(--muted);border-radius:10px;padding:12px 14px;background:rgba(148,163,184,.08);cursor:pointer;display:flex;flex-direction:column;gap:4px;min-width:280px}
    .muted{color:var(--muted)}
    .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--soft);color:var(--text);cursor:pointer}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border)}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:8px 8px 0 0;background:#0b1325;color:var(--text);cursor:pointer}
    .tab.active{background:var(--card);font-weight:600}
    .tab-panel{display:none;margin-top:12px} .tab-panel.active{display:block}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .table-wrap{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{border-collapse:collapse;width:100%} th,td{border-top:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#0b1325}
    .grid{display:grid;gap:12px}
    .chain-viewport{overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:#0b1325}
    .tier{margin:6px 0 12px 0}.tier h5{margin:0 0 6px 0;color:var(--muted);font-size:13px}
    .chips{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .chip{display:flex;flex-direction:column;gap:4px;padding:8px 10px;border-radius:8px;background:#0b1325;border:1px solid var(--border)}
    .chip .line1{display:flex;justify-content:space-between;font-size:12px}
    .chip .line2{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
    .badge{border-radius:999px;padding:1px 6px;font-size:10px;background:#334155;color:#fff}
    .chip .sla{width:10px;height:10px;border-radius:50%}
    .list{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(340px,1fr))}
    .error-banner{position:sticky;top:0;background:#7f1d1d;color:#fee2e2;padding:8px 12px;border:1px solid #fecaca;border-radius:8px;margin:10px 20px}
  </style>
</head>
<body>
  <div id="errorBanner" class="error-banner" style="display:none;"></div>
  <div id="debugDrawer" style="display:none; margin:10px 20px;" class="card"><pre id="debugLog" style="max-height:220px; overflow:auto; white-space:pre-wrap;"></pre></div>

  <header class="topbar">
    <h1>Maestro Certificate Rotation Dashboard</h1>
    <div class="actions header-actions"><button class="btn" id="btnClearHL" title="Clear highlight (Esc)">Clear highlight</button><button class="btn" id="btnDebug" onclick="toggleDebug()" title="Show debug">Debug</button>
      <button class="btn" id="btnCSV">Export CSV</button>
      <button class="btn" id="btnJSON">Export JSON</button>
      <button class="btn" id="btnRunbook">Runbook.md</button>
    </div>
  </header>

  <section class="uploader card">
    <div id="dropZone" class="drop-zone">
      <strong>Drop Maestro YAML files here</strong>
      <span class="muted">or click to select</span>
      <input id="fileInput" type="file" accept=".yml,.yaml" multiple hidden>
    </div>
    <button class="btn" id="btnClear">Clear</button>
    <span id="status" class="muted"></span>
  </section>

  <section class="card">
    <nav class="tabs">
      <button class="tab active" data-tab="timeline">Timeline</button>
      <button class="tab" data-tab="table">Table</button>
      <button class="tab" data-tab="chains">Chains</button>
      <button class="tab" data-tab="insights">Insights</button>
      <button class="tab" data-tab="deploy">Deployments</button>
    </nav>

    <div id="panel-timeline" class="tab-panel active">
      <div class="controls">
        <label>Foundation <select id="fnd"></select></label>
        <label>SLA
          <select id="sla">
            <option value="all">All</option>
            <option value="<=30">&#8804;30</option>
            <option value="<=60">&#8804;60</option>
            <option value="<=90">&#8804;90</option>
            <option value=">90">&gt;90</option>
            <option value="no-date">No date</option>
          </select>
        </label>
        <label class="chk"><input type="checkbox" id="onlyActive">Only active</label>
        <label class="chk"><input type="checkbox" id="onlyCA">Only CA</label>
        <label class="chk"><input type="checkbox" id="onlyTrans">Only transitional</label>
      </div>
      <div id="timelineEmpty" class="empty muted">Upload Maestro files to see a timeline.</div>
      <div id="timelineList" class="list"></div>
    </div>

    <div id="panel-table" class="tab-panel">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Foundation</th><th>Cert</th><th>Version</th><th>Issuer</th>
              <th>Active</th><th>CA</th><th>T</th><th>Deployments</th>
              <th>Valid Until</th><th>Days</th><th>SLA</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="panel-chains" class="tab-panel">
      <div class="controls">
        <label class="chk"><input type="checkbox" id="groupByFoundation">Group by foundation</label>
        <label>Zoom <input type="range" min="50" max="200" value="100" id="chainsZoom"> <span id="chainsZoomVal">100%</span></label>
        <label>Card height <input type="number" id="chainsMaxH" value="420" style="width:80px;"> px</label>
      </div>
      <div id="chains" class="grid" data-dynamic-cols></div>
    </div>

    <div id="panel-insights" class="tab-panel">
      <div class="controls">
        <label>Heatmap view
          <select id="insightsView">
            <option value="monthly">Monthly panels</option>
            <option value="calendar">Calendar strip</option>
            <option value="hist">Weekly histogram</option>
          </select>
        </label>
        <label class="chk"><input type="checkbox" id="groupHeatByFoundation">Group heatmap by foundation</label>
      </div>
      <div id="insights" class="grid"></div>
    </div>

    <div id="panel-deploy" class="tab-panel">
      <div class="controls">
        <label>deployment_name
          <input id="depQuery" list="depList" placeholder="e.g., diego-cell, router, uaa" style="min-width:280px;">
        </label>
        <datalist id="depList"></datalist>
        <label class="chk"><input type="checkbox" id="depExact">Exact match</label>
        <label class="chk"><input type="checkbox" id="depGroupByFoundation" checked>Group by foundation</label>
        <label>Zoom <input type="range" min="50" max="200" value="100" id="depZoom"> <span id="depZoomVal">100%</span></label>
        <label>Card height <input type="number" id="depMaxH" value="420" style="width:80px;"> px</label>
      </div>
      <div id="deployChains" class="grid" data-dynamic-cols></div>
      <div id="deployHelp" class="card" style="display:none;"></div>
    </div>

  </section>

  <script src="/static/js/app.js" defer></script>
</body>
</html>
